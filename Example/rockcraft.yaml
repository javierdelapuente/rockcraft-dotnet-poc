name: my-rock-name
# see https://documentation.ubuntu.com/rockcraft/en/latest/explanation/bases/
# for more information about bases and using 'bare' bases for chiselled rocks
base: ubuntu@24.04 # the base environment for this rock
version: '0.1' # just for humans. Semantic versioning is recommended
summary: Single-line elevator pitch for your amazing rock # 79 char long summary
description: |
    This is my-rock-name's description. You have a paragraph or two to tell the
    most important story about it. Keep it under 100 words though,
    we live in tweetspace and your description wants to look good in the
    container registries out there.
platforms: # the platforms this rock should be built on and run on
    amd64:

parts:
  simple-example-part:
    # user `plugin: dump` and `source: .` as an alternative, and dotnet publish
    # will not need a reference to CRAFT_PROJECT_DIR
    # plugin: nil
    plugin: dump
    source: .
    build-environment:
      # Do we really want this?
      - LD_LIBRARY_PATH: "/snap/dotnet-sdk-80/current/usr/lib/x86_64-linux-gnu"
      - DOTNET_NOLOGO: "1"
      - PATH: "/snap/dotnet-sdk-80/current/usr/lib/dotnet:${PATH}"
      # This are mine
      - DOTNET_PROJECT: "ExampleMvc/ExampleMvc.csproj"
      - SELF_CONTAINED: "false"
    build-packages:
      - "libicu74"
    build-snaps:
      - "dotnet-sdk-80"
    override-build: |
      # craftctl default  # We do not want to copy the project to the install location.
      dotnet restore --verbosity normal --runtime linux-x64 "${DOTNET_PROJECT}"
      dotnet build --no-restore --configuration Release --runtime linux-x64 --self-contained "${SELF_CONTAINED}" "${DOTNET_PROJECT}"
      dotnet publish --no-restore --no-build --configuration Release --runtime linux-x64 --self-contained "${SELF_CONTAINED}" --output "${CRAFT_PART_INSTALL}" "${DOTNET_PROJECT}"

      # Not sure if there is a better way
      csprojfile=$(basename -- "${DOTNET_PROJECT}")
      ln -s "/${csprojfile%.*}" ../install/runapp
    stage-snaps:
      - "aspnetcore-runtime-80"
    stage-packages:
      # Same error as in build...
      - "libicu74"

services:
  dotnet:
    override: replace
    # command: dotnet /ExampleMvc.dll
    command: /runapp
    startup: enabled
    # user: _daemon_
    environment:
      # https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/web-host?view=aspnetcore-9.0&preserve-view=true#server-urls
      ASPNETCORE_URLS: "http://*:5000"
